import { Rule, ScanFile, ScanIssue, RuleDefinition } from "../../types";

const definition: RuleDefinition = {
  id: "SEC006",
  name: "XSS Vulnerability",
  description:
    "Detects potential Cross-Site Scripting (XSS) vulnerabilities where unsanitized user input is rendered in responses.",
  category: "security",
  severity: "high",
  languages: ["javascript", "typescript", "python", "php", "ruby"],
  fixable: false,
};

const XSS_PATTERNS: RegExp[] = [
  /res\.send\s*\(\s*(?:req\.|request\.|params\.|query\.|body\.)/gi,
  /innerHTML\s*=\s*(?:req\.|request\.|params\.|query\.|body\.)/gi,
  /document\.write\s*\(\s*(?:req\.|request\.|params\.|query\.)/gi,
  /eval\s*\(\s*(?:req\.|request\.|params\.|query\.|body\.)/gi,
  /render_template_string\s*\(\s*(?:request\.|params\.|query\.)/gi,
  /echo\s+\$_(?:GET|POST|REQUEST|COOKIE)/gi,
  /print\s+.*(?:params\[|request\.)/gi,
];

const SANITIZE_PATTERNS: RegExp[] = [
  /sanitize/i,
  /escape/i,
  /encode/i,
  /DOMPurify/i,
  /xss/i,
  /htmlspecialchars/i,
  /h\(/,
  /bleach\./i,
  /markupsafe/i,
];

export const xssVulnerabilityRule: Rule = {
  definition,
  check(file: ScanFile): ScanIssue[] {
    const issues: ScanIssue[] = [];
    const lines = file.content.split("\n");

    lines.forEach((line, lineIndex) => {
      const trimmed = line.trim();
      if (trimmed.startsWith("//") || trimmed.startsWith("#")) return;
      if (SANITIZE_PATTERNS.some((p) => p.test(line))) return;

      for (const pattern of XSS_PATTERNS) {
        pattern.lastIndex = 0;
        const match = pattern.exec(line);
        if (match) {
          issues.push({
            ruleId: definition.id,
            ruleName: definition.name,
            category: definition.category,
            severity: definition.severity,
            message: "Potential XSS: unsanitized user input used in response",
            suggestion:
              "Sanitize user input before including it in responses. Use libraries like DOMPurify, validator.js, or framework-specific escaping functions. Never trust user input.",
            filePath: file.path,
            line: lineIndex + 1,
            column: match.index + 1,
            codeSnippet: trimmed,
            fixable: false,
          });
          break;
        }
      }
    });

    return issues;
  },
};
